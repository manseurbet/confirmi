<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Formulaire Client</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f6f8; padding: 30px; }
h2 { text-align: center; margin-bottom: 20px; }
form { max-width: 500px; margin: auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
label { display: block; margin-top: 15px; font-weight: bold; }
input, select { width: 100%; padding: 10px; margin-top: 6px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
input[readonly] { background-color: #eee; color: #555; }
button { width: 100%; margin-top: 25px; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
button:hover { background-color: #0056b3; }
#message { text-align:center; font-weight:bold; margin-bottom:20px; }
</style>
</head>
<body>

<h2>Confirmation de votre commande</h2>
<div id="message">Merci de confirmer votre commande via ce lien sécurisé Confirmi :</div>

<form id="clientForm">
  <label>Nom du client
    <input type="text" id="clientName" readonly>
  </label>
  
  <label>Référence produit
    <input type="text" id="productRef" readonly>
  </label>
  
  <label>Montant
    <input type="number" id="amount" readonly>
  </label>
  
  <label>Description
    <input type="text" id="description" readonly>
  </label>
  
  <label>Mode de paiement
    <select id="paymentMethod" required>
      <option value="">Choisir</option>
      <option value="especes">Espèces</option>
      <option value="virement">Virement</option>
      <option value="cheque">Chèque</option>
    </select>
  </label>
  
  <label>Pièce justificative (si nécessaire)
    <input type="file" id="paymentFile">
  </label>
  
  <button type="submit">Valider la commande</button>
</form>

<script>
const urlParams = new URLSearchParams(window.location.search);
const transactionId = urlParams.get("id");

if (!transactionId) {
  alert("ID de transaction manquant !");
  document.getElementById("clientForm").style.display = "none";
  throw new Error("ID de transaction manquant");
}

const form = document.getElementById("clientForm");

// Récupérer transaction
fetch(`/transaction/${transactionId}`)
  .then(res => {
    if (!res.ok) throw new Error("Transaction introuvable");
    return res.json();
  })
  .then(tx => {
    if (tx.status === "validated") {
      form.innerHTML = "<p style='text-align:center; font-weight:bold;'>Cette commande a déjà été confirmée. Aucune modification n’est possible.</p>";
      return;
    }

    // Pré-remplissage
    document.getElementById("clientName").value = tx.clientName || "";
    document.getElementById("productRef").value = tx.productRef || "";
    document.getElementById("amount").value = tx.amount || "";
    document.getElementById("description").value = tx.description || "";

    // Option mode paiement pré-sélection
    if(tx.paymentMethod) document.getElementById("paymentMethod").value = tx.paymentMethod;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = new FormData();
      data.append("paymentMethod", document.getElementById("paymentMethod").value);
      if(document.getElementById("paymentFile").files[0]) {
        data.append("paymentFile", document.getElementById("paymentFile").files[0]);
      }

      const res = await fetch(`/validate-transaction/${transactionId}`, { method: "POST", body: data });
      const result = await res.json();

      if(result.success) {
        alert("Commande validée !");
        location.reload(); // recharge le formulaire pour afficher blocage
      } else {
        alert(result.error || "Erreur lors de la validation");
      }
    });
  })
  .catch(err => {
    console.error(err);
    form.innerHTML = "<p style='text-align:center; font-weight:bold;'>Erreur serveur : " + err.message + "</p>";
  });
</script>

</body>
</html>










