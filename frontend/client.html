<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Confirmation de commande</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f6f8;
  padding: 30px;
}

form, .final {
  max-width: 500px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

label {
  display: block;
  margin-top: 15px;
}

input, select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
}

button {
  margin-top: 25px;
  width: 100%;
  padding: 12px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 8px;
}

.final {
  text-align: center;
}
</style>
</head>

<body>

<form id="form">
  <h2>Confirmation de commande</h2>

  <p><strong>Merci de confirmer votre commande via ce lien sécurisé Confirmi.</strong></p>

  <label>Nom du client
    <input id="clientName" readonly>
  </label>

  <label>Référence produit
    <input id="productRef" readonly>
  </label>

  <label>Montant
    <input id="amount" readonly>
  </label>

  <label>Description
    <input id="description" readonly>
  </label>

  <label>Mode de paiement
    <select name="paymentMode" id="paymentMode">
      <option value="espece">Espèce</option>
      <option value="virement">Virement</option>
    </select>
  </label>

  <label id="proofBlock" style="display:none;">
    Justificatif
    <input type="file" name="proof">
  </label>

  <button type="submit">Valider définitivement</button>
</form>

<div class="final" id="final" style="display:none;">
  <h3>✅ Transaction déjà validée</h3>
  <p>Cette commande a déjà été confirmée.<br>
  Aucune modification n’est possible.</p>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if (!id) {
  document.body.innerHTML = "ID de transaction manquant";
}

// récupération transaction depuis le serveur
fetch(`/transaction/${id}`)
  .then(r => r.json())
  .then(t => {
    if (!t || t.status === undefined) {
      document.body.innerHTML = "Transaction introuvable";
      return;
    }

    if (t.status === "validated") {
      document.getElementById("form").style.display = "none";
      document.getElementById("final").style.display = "block";
      return;
    }

    // pré-remplissage avec sécurité
    clientName.value = t.clientName || "";
    productRef.value = t.productRef || "";
    amount.value = t.amount || "";
    description.value = t.description || "";

    // sélection mode de paiement si déjà défini
    if (t.paymentMode) {
      paymentMode.value = t.paymentMode;
      proofBlock.style.display = t.paymentMode === "virement" ? "block" : "none";
    }
  })
  .catch(err => {
    console.error(err);
    document.body.innerHTML = "Erreur lors de la récupération de la transaction";
  });

// affichage conditionnel du justificatif
paymentMode.onchange = () => {
  proofBlock.style.display = paymentMode.value === "virement" ? "block" : "none";
};

// soumission du formulaire
document.getElementById("form").addEventListener("submit", e => {
  e.preventDefault();

  const data = new FormData(e.target);

  fetch(`/validate/${id}`, {
    method: "POST",
    body: data
  })
  .then(r => r.json())
  .then(res => {
    if (res.success) {
      document.getElementById("form").style.display = "none";
      document.getElementById("final").style.display = "block";
    } else {
      alert(res.message || "Erreur");
    }
  });
});
</script>

</body>
</html>









