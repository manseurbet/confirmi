<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Formulaire Client</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ======= Global ======= */
body {
  font-family: Arial, sans-serif;
  background: #f5f6f8;
  margin: 0;
  padding: 15px;
}

/* ======= Titre ======= */
h2 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 20px;
}

/* ======= Formulaire ======= */
form {
  max-width: 500px;
  width: 90%;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  box-sizing: border-box;
}

label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 16px;
  box-sizing: border-box;
}

input[readonly] {
  background: #eee;
  color: #555;
}

/* ======= Bouton ======= */
button {
  width: 100%;
  margin-top: 25px;
  padding: 14px;
  background-color: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
}

button:hover {
  background-color: #218838;
}

/* ======= Message confirmation ======= */
.confirmed-msg {
  margin-top: 20px;
  color: #155724;
  background: #d4edda;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  font-size: 16px;
}

/* ======= Responsive ======= */
@media (max-width: 600px) {
  h2 { font-size: 18px; }
  input, select { font-size: 18px; }
  button { font-size: 20px; padding: 16px; }
}
</style>
</head>
<body>

<h2>Merci de confirmer votre commande via ce lien sécurisé "Confirmi"</h2>

<form id="clientForm" enctype="multipart/form-data">
  <label>Nom du client
    <input type="text" id="clientName" readonly>
  </label>

  <label>Référence produit
    <input type="text" id="productRef" readonly>
  </label>

  <label>Montant
    <input type="number" id="amount" readonly>
  </label>

  <label>Description
    <input type="text" id="description" readonly>
  </label>

  <label>Mode de paiement
    <select id="paymentMethod" required>
      <option value="transfer">Virement</option>
      <option value="Especes">Espèces</option>
    </select>
  </label>

  <label id="attachmentLabel">Pièce justificative
    <input type="file" id="attachment">
  </label>

  <button type="submit">Confirmer la transaction</button>
</form>

<script>
// ======= Récupération transaction =======
function getTransactionId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

async function loadTransaction() {
  const id = getTransactionId();
  if (!id) { alert("ID de transaction manquant !"); return; }

  try {
    const res = await fetch(`/transaction/${id}`);
    const data = await res.json();
    if (!data.success) { alert("Transaction introuvable !"); return; }

    const t = data.transaction;
    document.getElementById("clientName").value = t.clientName;
    document.getElementById("productRef").value = t.productRef;
    document.getElementById("amount").value = t.amount;
    document.getElementById("description").value = t.description || "";

    // Si transaction déjà validée
    if(t.confirmed) {
      document.querySelectorAll("input, select, textarea, button").forEach(el => el.disabled = true);

      // message
      const msg = document.createElement("div");
      msg.className = "confirmed-msg";
      msg.textContent = "Cette transaction a déjà été validée.";
      document.getElementById("clientForm").after(msg);
    }

  } catch (err) {
    console.error(err);
    alert("Erreur lors du chargement de la transaction !");
  }
}

// ======= Validation dynamique =======
const paymentMethod = document.getElementById("paymentMethod");
const attachment = document.getElementById("attachment");

paymentMethod.addEventListener("change", () => {
  if(paymentMethod.value === "Especes") {
    attachment.removeAttribute("required");
    attachment.value = "";
  } else {
    attachment.setAttribute("required", true);
  }
});

// ======= Submit et upload =======
document.getElementById("clientForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = getTransactionId();
  if(!id) { alert("ID manquant"); return; }

  const payment = paymentMethod.value;
  const file = attachment.files[0];

  if (!payment) {
    alert("Veuillez choisir un mode de paiement.");
    return;
  }

  if (payment !== "Especes" && !file) {
    alert("Veuillez joindre la pièce justificative.");
    return;
  }

  const formData = new FormData();
  formData.append("paymentMethod", payment);
  if(file) formData.append("attachment", file);

  try {
    const res = await fetch(`/confirm-transaction/${id}`, {
      method: "POST",
      body: formData
    });
    const data = await res.json();

    if(data.success){
      alert("Transaction confirmée !");
      // Bloquer le formulaire après validation
      document.querySelectorAll("input, select, textarea, button").forEach(el => el.disabled = true);

      // message
      const msg = document.createElement("div");
      msg.className = "confirmed-msg";
      msg.textContent = "Cette transaction a déjà été validée.";
      document.getElementById("clientForm").after(msg);

    } else {
      alert("Erreur : " + data.message);
    }
  } catch(err){
    console.error(err);
    alert("Erreur lors de l'envoi de la transaction !");
  }
});

loadTransaction();
</script>

</body>
</html>











