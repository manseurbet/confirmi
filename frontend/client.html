<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Formulaire Client</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f6f8; margin:0; padding:30px; }
h2 { text-align:center; margin-bottom:20px; }
form { max-width:500px; margin:auto; background:#fff; padding:25px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
label { display:block; margin-top:15px; font-weight:bold; }
input, select { width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; font-size:14px; }
input[readonly] { background:#eee; color:#555; }
button { width:100%; margin-top:25px; padding:12px; background-color:#28a745; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
button:hover { background-color:#218838; }
</style>
</head>
<body>

<h2>Merci de confirmer votre commande via ce lien sécurisé "Confirmi" :</h2>

<form id="clientForm" enctype="multipart/form-data">
  <label>Nom du client
    <input type="text" id="clientName" readonly>
  </label>

  <label>Référence produit
    <input type="text" id="productRef" readonly>
  </label>

  <label>Montant
    <input type="number" id="amount" readonly>
  </label>

  <label>Description
    <input type="text" id="description" readonly>
  </label>

  <label>Mode de paiement
    <select id="paymentMethod" required>
      <option value="especes">Espèces</option>
      <option value="transfer">Virement</option>
    </select>
  </label>

  <label id="attachmentLabel">Pièce justificative
    <input type="file" id="attachment">
  </label>

  <button type="submit">Confirmer la transaction</button>
</form>

<script>
// --------------------
// Récupération transaction
// --------------------
function getTransactionId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

async function loadTransaction() {
  const id = getTransactionId();
  if (!id) { alert("ID de transaction manquant !"); return; }

  try {
    const res = await fetch(`/transaction/${id}`);
    const data = await res.json();
    if (!data.success) { alert("Transaction introuvable !"); return; }

    const t = data.transaction;
    document.getElementById("clientName").value = t.clientName;
    document.getElementById("productRef").value = t.productRef;
    document.getElementById("amount").value = t.amount;
    document.getElementById("description").value = t.description || "";

    if(t.paymentMethod){
      const pm = document.getElementById("paymentMethod");
      pm.value = t.paymentMethod.toLowerCase();
      pm.disabled = true;
      document.getElementById("attachment").disabled = true;
    }

  } catch (err) {
    console.error(err);
    alert("Erreur lors du chargement de la transaction !");
  }
}

loadTransaction();

// --------------------
// Gestion dynamique du champ pièce justificative
// --------------------
const paymentSelect = document.getElementById("paymentMethod");
const attachment = document.getElementById("attachment");
const attachmentLabel = document.getElementById("attachmentLabel");

function toggleAttachment() {
  if(paymentSelect.value.toLowerCase() === "especes") {
    attachment.required = false;
    attachment.value = "";
    attachment.disabled = true;
    attachmentLabel.style.display = "none";
  } else {
    attachment.required = true;
    attachment.disabled = false;
    attachmentLabel.style.display = "block";
  }
}

// Exécution au changement
paymentSelect.addEventListener("change", toggleAttachment);
toggleAttachment(); // exécution au chargement

// --------------------
// Submit et upload
// --------------------
document.getElementById("clientForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const id = getTransactionId();
  if(!id) { alert("ID manquant"); return; }

  const payment = paymentSelect.value;
  const file = attachment.files[0];

  if(!payment){
    alert("Veuillez choisir un mode de paiement.");
    return;
  }

  if(payment.toLowerCase() !== "especes" && !file){
    alert("Veuillez joindre la pièce justificative.");
    return;
  }

  const formData = new FormData();
  formData.append("paymentMethod", payment);
  if(file) formData.append("attachment", file);

  try {
    const res = await fetch(`/confirm-transaction/${id}`, {
      method: "POST",
      body: formData
    });
    const data = await res.json();

    if(data.success){
      alert("Transaction confirmée !");
      paymentSelect.disabled = true;
      attachment.disabled = true;
    } else {
      alert("Erreur : " + data.message);
    }
  } catch(err){
    console.error(err);
    alert("Erreur lors de l'envoi de la transaction !");
  }
});
</script>

</body>
</html>











