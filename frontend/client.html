<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Confirmation de commande – Confirmi</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f6f8;
  padding: 30px;
}

form {
  max-width: 500px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
}

input, select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

input[readonly] {
  background: #eee;
}

button {
  margin-top: 25px;
  width: 100%;
  padding: 12px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
}

button:disabled {
  background: #999;
  cursor: not-allowed;
}

.hidden {
  display: none;
}
</style>
</head>

<body>

<p id="introText" style="text-align:center;font-weight:bold;"></p>

<form id="clientForm">

  <label>Nom du client
    <input id="clientName" readonly>
  </label>

  <label>Référence produit
    <input id="productRef" readonly>
  </label>

  <label>Montant
    <input id="amount" readonly>
  </label>

  <label>Description
    <input id="description" readonly>
  </label>

  <label>Mode de paiement
    <select id="paymentMethod" required>
      <option value="">-- Choisir --</option>
      <option value="especes">Espèces</option>
      <option value="virement">Virement</option>
      <option value="cheque">Chèque</option>
    </select>
  </label>

  <label id="uploadLabel" class="hidden">
    Justificatif de paiement
    <input type="file" id="paymentFile" accept="image/*,application/pdf">
  </label>

  <button type="submit">Valider la commande</button>

</form>

<script>
const params = new URLSearchParams(window.location.search);
const transactionId = params.get("id");

if (!transactionId) {
  alert("ID de transaction manquant.");
  throw new Error("ID manquant");
}

const introText = document.getElementById("introText");
const form = document.getElementById("clientForm");
const paymentMethod = document.getElementById("paymentMethod");
const uploadLabel = document.getElementById("uploadLabel");
const paymentFile = document.getElementById("paymentFile");

// Chargement transaction
fetch(`/transaction/${transactionId}`)
  .then(res => {
    if (!res.ok) throw new Error("Transaction introuvable");
    return res.json();
  })
  .then(data => {

    introText.innerText =
      "Merci de confirmer votre commande via ce lien sécurisé Confirmi :";

    document.getElementById("clientName").value = data.clientName;
    document.getElementById("productRef").value = data.productRef;
    document.getElementById("amount").value = data.amount;
    document.getElementById("description").value = data.description || "";

    // Déjà validée
    if (data.status === "validated") {
      alert("Cette commande a déjà été confirmée.\nAucune modification n’est possible.");
      form.querySelectorAll("input, select, button")
        .forEach(el => el.disabled = true);
    }
  })
  .catch(err => {
    alert("Erreur lors du chargement de la commande.");
    console.error(err);
  });

// Gestion mode de paiement
paymentMethod.addEventListener("change", () => {
  if (paymentMethod.value === "especes") {
    uploadLabel.classList.add("hidden");
    paymentFile.value = "";
  } else {
    uploadLabel.classList.remove("hidden");
  }
});

// Validation
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!paymentMethod.value) {
    alert("Veuillez choisir un mode de paiement.");
    return;
  }

  if (paymentMethod.value !== "especes" && paymentFile.files.length === 0) {
    alert("Veuillez joindre un justificatif.");
    return;
  }

  const formData = new FormData();
  formData.append("paymentMethod", paymentMethod.value);
  if (paymentFile.files[0]) {
    formData.append("paymentFile", paymentFile.files[0]);
  }

  const res = await fetch(`/validate-transaction/${transactionId}`, {
    method: "POST",
    body: formData
  });

  if (res.ok) {
    alert("Commande confirmée avec succès.");
    location.reload();
  } else {
    alert("Erreur lors de la validation.");
  }
});
</script>

</body>
</html>










